[SERVICE]
    Flush         5
    Daemon        Off
    Log_Level     info
    Parsers_File  /fluent-bit/etc/parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

[INPUT]
    Name          forward
    Listen        0.0.0.0
    Port          24224
    Tag           app.*

# Step 1: Parse JSON from Docker fluentd log driver.
# On success, top-level JSON fields (incl. _logType) are promoted.
# On failure, the record passes through without _logType.
[FILTER]
    Name          parser
    Match         app.*
    Key_Name      log
    Parser        docker_json
    Reserve_Data  On

# Step 2: Keep only audit log records.
# Non-JSON lines and non-audit JSON lines lack _logType=audit,
# so they are naturally excluded by this grep filter.
[FILTER]
    Name          grep
    Match         app.*
    Regex         _logType ^audit$

# ─── OUTPUT DESTINATIONS ───────────────────────────────
# Uncomment the output(s) you want. Multiple outputs are supported.

# --- Default: stdout (for testing/debugging) ---
[OUTPUT]
    Name          stdout
    Match         app.*
    Format        json_lines

# --- Syslog (RFC 5424 over TLS) ---
# [OUTPUT]
#     Name                 syslog
#     Match                app.*
#     Host                 ${SYSLOG_HOST}
#     Port                 ${SYSLOG_PORT}
#     Mode                 tcp
#     Syslog_Format        rfc5424
#     Syslog_Hostname_key  _app
#     Syslog_Appname_key   _app
#     Syslog_Message_key   msg
#     tls                  On

# --- Elasticsearch ---
# [OUTPUT]
#     Name                 es
#     Match                app.*
#     Host                 ${ES_HOST}
#     Port                 ${ES_PORT}
#     Index                audit-logs
#     Logstash_Format      On
#     Logstash_Prefix      audit
#     Suppress_Type_Name   On
#     tls                  On
#     HTTP_User            ${ES_USER}
#     HTTP_Passwd          ${ES_PASSWORD}

# --- Grafana Loki ---
# [OUTPUT]
#     Name                 loki
#     Match                app.*
#     Host                 ${LOKI_HOST}
#     Port                 ${LOKI_PORT}
#     Labels               job=passwd-sso,log_type=audit
#     Line_Format          json
#     tls                  On

# --- S3 (archival) ---
# [OUTPUT]
#     Name                 s3
#     Match                app.*
#     Region               ${AWS_REGION}
#     Bucket               ${S3_AUDIT_BUCKET}
#     Total_File_Size      10M
#     Upload_Timeout       60s
#     S3_Key_Format        /audit-logs/%Y/%m/%d/$TAG-%H%M%S-$UUID.json
#     Use_Put_Object       On
#     Compression          gzip

# --- Splunk HEC ---
# [OUTPUT]
#     Name                 splunk
#     Match                app.*
#     Host                 ${SPLUNK_HOST}
#     Port                 ${SPLUNK_PORT}
#     Splunk_Token         ${SPLUNK_TOKEN}
#     Splunk_Send_Raw      On
#     tls                  On
