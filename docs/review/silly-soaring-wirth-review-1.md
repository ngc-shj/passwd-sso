# プランレビュー: チーム保管庫 エントリ複数選択 + 一括操作

日時: 2026-03-01T12:00:00+09:00
レビュー回数: 1回目（再評価済み）

## 前回からの変更

初回レビュー → 全20項目を再評価。「個人版がこうだから対応しない」を理由としない方針で見直し。

## 機能観点の指摘

| ID | 重要度 | 状態 | 概要 |
|----|--------|------|------|
| F-1 | 高 | 反映済み | RLSコンテキスト関数の選択が未確定 |
| F-2 | 高 | 反映済み | 選択ボタン `!isTeamSpecialView` でアーカイブ/ゴミ箱ビュー使用不可 |
| F-3 | 中 | 反映済み | 通常ビューの全選択チェックボックス方針が不足 |
| F-4 | 低 | **反映済み** | teamId optional設計のガード |
| F-5 | 中 | **解決済み** | PASSWORD_DELETE for bulk-archive → 全て PASSWORD_DELETE で統一 |
| F-6 | 中 | 反映済み | withRequestLog ラッパーの記載漏れ |
| F-7 | 中 | 反映済み | テストファイルが変更対象に含まれていない |
| F-8 | 中 | 反映済み | params の await パターン記載漏れ |

**F-4**: 防御的コーディングとして `teamId` 未指定時に選択モードを強制off にするガードを追加。コスト極小で将来のバグを防止。

**F-5**: ユーザー確認の結果、全3本 `PASSWORD_DELETE` で統一。一括操作は影響範囲が大きく上位権限を要求するパターン。MEMBERは単体APIで個別アーカイブ可能。

## セキュリティ観点の指摘

| ID | 重要度 | 状態 | 概要 |
|----|--------|------|------|
| S-1 | 高 | 反映済み | ids配列の上限値が未設定 (DoS) |
| S-2 | 低 | スキップ | オラクル攻撃（requestedCount vs movedCount差分） |
| S-3 | 中 | **解決済み** | 認可権限の粒度 → F-5で統一決定済み |
| S-4 | 中 | 反映済み | RLSコンテキスト → F-1で解決済み |
| S-5 | 中 | **反映済み** | 監査ログの正確性（updateMany後のre-fetch） |
| S-6 | 中 | 反映済み | withRequestLog → F-6で解決済み |

**S-2**: スキップ — findManyのwhere句にteamIdを含むため、クロスチーム情報漏洩は**構造的に不可能**。requestedCountとmovedCountの差分は同一チーム内の状態不一致（既にトラッシュ済み等）のみを反映。

**S-5**: bulk-archive/bulk-restoreで updateMany後にre-fetchせず、findMany時点のIDリストを監査ログに使用していた問題。bulk-trashはre-fetchパターンを使用（正しい）。個人版・チーム版ともにbulk-trashと同じパターンに統一。

## テスト観点の指摘

| ID | 重要度 | 状態 | 概要 |
|----|--------|------|------|
| T-1 | 高 | 反映済み | テストパターン基準の不在 → 個人版+チーム版テスト追加 |
| T-2 | 高 | 反映済み | ids配列サイズ上限 → S-1で解決済み |
| T-3 | 高 | **解決済み** | 認可モデルの曖昧さ → F-5で統一決定済み |
| T-4 | 低 | スキップ（別PR） | カバレッジ閾値未設定 |
| T-5 | 中 | **反映済み** | CI RLSチェックの網羅性 → 検証ステップに追加 |
| T-6 | 低 | スキップ | E2E自動テストなし |

**T-4**: プロジェクト全体のvitest.config.tsに影響する設定変更。本PRとは独立した課題として別PRで対応すべき。

**T-5**: `npm run check:team-auth-rls` が新規バルクAPIファイルを検出対象に含むことを検証ステップに追加。

**T-6**: APIユニットテストでRBAC（4ロール）を網羅的にテスト。E2Eはチーム用バルク操作のセットアップが複雑であり、ユニットテストで十分なカバレッジが確保できる。E2E追加はプロジェクト全体のテスト戦略として別途検討。

## 対応サマリ

| 判定 | 件数 | 指摘ID |
|------|------|--------|
| 反映済み | 14 | F-1〜F-4, F-6〜F-8, S-1, S-4〜S-6, T-1, T-2, T-5 |
| 解決済み | 3 | F-5, S-3, T-3 |
| スキップ | 3 | S-2（構造的に不可能）, T-4（別PR）, T-6（ユニットテストで十分） |
