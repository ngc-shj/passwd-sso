# プランレビュー: クロステナント識別機能

日時: 2026-03-01T04:30:00+09:00
レビュー回数: 2回（2回目で全観点クリア）

## ループ1: 初回レビュー

### 機能観点の指摘 (6件)

| ID | 重要度 | 状態 | 概要 |
|----|--------|------|------|
| F-1 | 低 | 反映済み | `GET /api/teams` で追加トランザクション発生 |
| F-2 | 中 | 反映済み | `getTeamMembership` 内の追加クエリが全アクセスに影響 |
| F-3 | 高 | 反映済み | `getLogger("team-auth")` — API不一致でビルドエラー |
| F-4 | 低 | スキップ | `withBypassRls` の import 追加漏れリスク |
| F-5 | 低 | 反映済み | バッチテナント取得の複数レコード上書きリスク |
| F-6 | 低 | 反映済み | `SelectItem` レイアウト崩れ |

### セキュリティ観点の指摘 (3件)

| ID | 重要度 | 状態 | 概要 |
|----|--------|------|------|
| S-1 | 中 | スキップ | `withBypassRls` による他テナントユーザーのテナント名取得 |
| S-2 | 低 | 反映済み | デバッグログの配置場所とレベル |
| S-3 | 低 | スキップ | テナント名開示範囲の設計意図 |

### テスト観点の指摘 (12件)

| ID | 重要度 | 状態 | 概要 |
|----|--------|------|------|
| T-1,4 | 中 | 反映済み | モックデータに `tenant` がない |
| T-2,5 | 中 | 反映済み | null tenant の境界値 |
| T-9-11 | 中 | 反映済み | logger モック・引数・偽陽性検証 |
| T-3,6,7,8,12 | 低 | スキップ | 詳細テスト実装ノート |

## ループ2: 再レビュー

### 機能観点

- 前回指摘の対応を確認: 全て正しく反映
- 新規指摘: `MULTI_TENANT_MEMBERSHIP_NOT_SUPPORTED` エラーケースのテスト追加 → 対応済み（8A）

### セキュリティ観点

- **指摘なし**

### テスト観点

- **指摘なし**

## 対応サマリ

| 判定 | 件数 | 指摘ID |
|------|------|--------|
| 反映済み | 12 | F-1, F-2, F-3, F-5, F-6, S-2, T-1,4, T-2,5, T-9-11 + ループ2新規1件 |
| スキップ | 5 | F-4（明示済み）, S-1（ユーザー要件）, S-3（注記で対応）, T-3,6,7,8,12（具体化で吸収） |
